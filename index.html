<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>TECHSUP • Vendor Status</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="/logo.svg" />
  <style>
    :root{
      --mint:#00A88F;      /* brand */
      --ink:#0b0d10;
      --paper:#ffffff;
      --muted:#5a6370;
      --border:#e7ebef;
      --ok:#00A88F;
      --degraded:#f9a825;
      --outage:#d32f2f;
      --unknown:#9ea7b3;
      --shadow:0 4px 12px rgba(0,0,0,.08);
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:#f7fafb;color:var(--ink);font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif}
    a{color:inherit}
    .wrap{max-width:1100px;margin:0 auto;padding:16px}

    header{border-bottom:1px solid var(--border);background:#fff;position:sticky;top:0;z-index:50}
    .brand{display:flex;align-items:center;gap:10px}
    .brand img.mascot{height:32px;width:auto}
    .brand h1{font-size:18px;margin:0;font-weight:700;letter-spacing:.5px}

    .hero{background:#fff;border-bottom:1px solid var(--border)}
    .hero .kpis{display:flex;gap:12px;flex-wrap:wrap;margin-top:10px}
    .pill{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--border);background:#fff;border-radius:999px;padding:6px 10px;font-size:12px}
    .dot{width:10px;height:10px;border-radius:50%}
    .dot.ok{background:var(--ok)}
    .dot.degraded{background:var(--degraded)}
    .dot.outage{background:var(--outage)}
    .dot.unknown{background:var(--unknown)}

    .banner{margin-top:8px;border:1px solid var(--border);background:#fff;border-radius:10px;padding:10px;box-shadow:var(--shadow);font-size:14px}
    .controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:14px}
    .btn{border:1px solid var(--border);background:#fff;border-radius:10px;padding:8px 12px;font-size:14px;cursor:pointer}
    .btn[aria-pressed="true"]{outline:2px solid rgba(0,168,143,.35)}
    .btnBrand{background:var(--mint);color:#fff;border-color:transparent}
    .btn:focus-visible{outline:3px solid rgba(0,168,143,.25);outline-offset:2px}

    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:12px;margin-top:14px}
    .card{border:1px solid var(--border);background:#fff;border-radius:12px;padding:12px;box-shadow:var(--shadow);display:flex;gap:12px}
    .name{font-weight:700}
    .note{color:var(--muted);font-size:13px;margin-top:4px}
    .src{font-size:12px;color:var(--muted);margin-top:6px}

    .section{margin-top:18px}
    .section h2{font-size:14px;margin:0 0 8px 0;color:var(--muted);font-weight:600;text-transform:uppercase;letter-spacing:.5px}

    .stickyBar{position:fixed;right:16px;bottom:16px;background:#101316;color:#fff;border-radius:999px;padding:10px 14px;display:flex;align-items:center;gap:8px;box-shadow:0 8px 24px rgba(0,0,0,.25)}
    .stickyBar .text{font-size:13px}
    .hide{display:none}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="brand">
        <img src="/logo.svg" alt="Logo" height="20" />
        <img src="/mascot-techsup.png" class="mascot" alt="TECHSUP mascot" loading="lazy" decoding="async" />
        <h1>TECHSUP</h1>
      </div>
    </div>
  </header>

  <section class="hero">
    <div class="wrap">
      <div id="banner" class="banner"></div>

      <div class="kpis" id="kpis">
        <div class="pill"><span class="dot ok"></span><span id="k_ok">0</span> OK</div>
        <div class="pill"><span class="dot degraded"></span><span id="k_degraded">0</span> Dégradés</div>
        <div class="pill"><span class="dot outage"></span><span id="k_outage">0</span> En panne</div>
      </div>

      <div class="controls" role="toolbar" aria-label="Filtrer par statut">
        <button class="btn" data-filter="all" aria-pressed="true">Tout</button>
        <button class="btn" data-filter="ok">OK</button>
        <button class="btn" data-filter="degraded">Dégradé</button>
        <button class="btn" data-filter="outage">Panne</button>
        <button id="btnRaw" class="btn btnBrand" style="margin-left:auto">Raw JSON</button>
      </div>

      <div class="section">
        <h2>Tous les services</h2>
        <div id="list_all" class="grid"></div>
      </div>

      <div class="section">
        <h2>Impactés</h2>
        <div id="list_bad" class="grid"></div>
      </div>
    </div>
  </section>

  <div id="sticky" class="stickyBar hide" aria-live="polite">
    <span class="dot" id="stickyDot"></span>
    <span class="text" id="stickyText">Statut</span>
  </div>

  <script>
    // ---------- Helpers ----------
    const qs = (s,el=document)=>el.querySelector(s);
    const qsa = (s,el=document)=>Array.from(el.querySelectorAll(s));
    const el = (tag, cls='') => { const e = document.createElement(tag); if (cls) e.className = cls; return e; };

    const statusClass = s => ({ operational:'ok', ok:'ok', degraded:'degraded', partial:'degraded', outage:'outage', down:'outage' }[String(s||'').toLowerCase()] || 'unknown');

    let lastSourceUrl = '/services.json';

    // Try /api/status then fallback to /services.json
    async function loadStatus() {
      const ts = Date.now();
      try {
        const r = await fetch(`/api/status?ts=${ts}`, { cache: 'no-store' });
        if (!r.ok) throw new Error('api not ok');
        const j = await r.json();
        lastSourceUrl = '/api/status';
        return j;
      } catch {
        const r2 = await fetch(`/services.json?ts=${ts}`, { cache: 'no-store' });
        if (!r2.ok) throw new Error('json not ok');
        const j2 = await r2.json();
        lastSourceUrl = '/services.json';
        return j2;
      }
    }

    function setRawButton() {
      const btn = qs('#btnRaw');
      btn.onclick = () => {
        const w = 900, h = 700;
        const left = Math.round((window.screen.width - w) / 2);
        const top = Math.round((window.screen.height - h) / 2);
        window.open(lastSourceUrl, '_blank', `popup=yes,width=${w},height=${h},left=${left},top=${top}`);
      };
    }

    function renderStatus(data) {
      // Banner
      const banner = qs('#banner');
      const bannerText = data.banner || 'Statut des fournisseurs';
      const updated = data.lastUpdatedISO ? new Date(data.lastUpdatedISO).toLocaleString() : '';
      banner.innerHTML = `<strong>${bannerText}</strong>${updated ? ` <span style="color:var(--muted)">• Mise à jour: ${updated}</span>` : ''}`;

      // Lists
      const all = Array.isArray(data.services) ? data.services : [];
      const bad = all.filter(s => ['degraded','outage'].includes(statusClass(s.status)));

      // KPIs
      qs('#k_ok').textContent = all.filter(s => statusClass(s.status) === 'ok').length;
      qs('#k_degraded').textContent = all.filter(s => statusClass(s.status) === 'degraded').length;
      qs('#k_outage').textContent = all.filter(s => statusClass(s.status) === 'outage').length;

      const $all = qs('#list_all'); $all.innerHTML = '';
      const $bad = qs('#list_bad'); $bad.innerHTML = '';

      const makeCard = (svc) => {
        const cls = statusClass(svc.status);
        const card = el('div', `card item ${cls}`);
        card.dataset.status = cls;

        const dot = el('div', `dot ${cls}`); dot.setAttribute('title', cls);
        const body = el('div');

        const name = el('div', 'name');
        if (svc.link) {
          const a = el('a'); a.href = svc.link; a.target = '_blank'; a.rel = 'noreferrer noopener'; a.textContent = svc.name;
          name.appendChild(a);
        } else {
          name.textContent = svc.name;
        }

        const note = el('div', 'note'); note.textContent = svc.note || '';

        const src = el('div', 'src');
        if (svc.link) {
          try {
            const host = new URL(svc.link).host;
            src.innerHTML = `Source : <a href="${svc.link}" target="_blank" rel="noreferrer noopener">${host}</a>`;
          } catch { /* ignore bad URL */ }
        }

        body.appendChild(name);
        if (svc.note) body.appendChild(note);
        if (svc.link) body.appendChild(src);

        card.appendChild(dot);
        card.appendChild(body);
        return card;
      };

      all.forEach(svc => $all.appendChild(makeCard(svc)));
      bad.forEach(svc => $bad.appendChild(makeCard(svc)));

      // Sticky bar
      const sticky = qs('#sticky');
      const stickyDot = qs('#stickyDot');
      const stickyText = qs('#stickyText');
      const n = bad.length;
      sticky.classList.toggle('hide', n === 0);
      stickyDot.className = `dot ${n ? (bad.some(s=>statusClass(s.status)==='outage') ? 'outage' : 'degraded') : 'ok'}`;
      stickyText.textContent = n ? `${n} fournisseur${n>1?'s':''} impacté${n>1?'s':''}` : 'Tous les systèmes OK';

      // Filters
      qsa('.controls .btn[data-filter]').forEach(b => {
        b.addEventListener('click', () => {
          qsa('.controls .btn[data-filter]').forEach(x => x.setAttribute('aria-pressed', 'false'));
          b.setAttribute('aria-pressed', 'true');
          const f = b.dataset.filter;
          qsa('.card.item').forEach(c => {
            c.hidden = f !== 'all' && c.dataset.status !== f;
          });
        });
      });
    }

    (async () => {
      try {
        const data = await loadStatus();
        renderStatus(data);
        setRawButton();
      } catch (e) {
        qs('#banner').textContent = 'Impossible de charger le statut.';
        console.error(e);
      }
    })();
  </script>
</body>
</html>
